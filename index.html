<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG System - Live Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white">
    
    <!-- Nawigacja -->
    <div class="fixed top-4 right-4 z-50 flex gap-2">
        <button onclick="showSlide(0)" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg backdrop-blur-sm transition text-sm">
            Jak działa
        </button>
        <button onclick="showSlide(1)" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition text-sm font-bold">
            Live Demo
        </button>
    </div>

    <div id="slides-container" class="min-h-screen"></div>

    <script>
        // URL BACKENDU Z RENDER
        const BACKEND_URL = 'https://rag-backend-2lo0.onrender.com';

        const slides = [
            // Slide 1: Jak działa
            `<div class="min-h-screen flex items-center justify-center p-8">
                <div class="max-w-5xl w-full space-y-8">
                    <h2 class="text-5xl font-bold mb-8 text-center">Jak to działa?</h2>
                    
                    <div class="bg-white/5 border border-gray-600 rounded-xl p-6 space-y-4">
                        <h3 class="text-2xl font-bold text-blue-400">1. Przygotowanie materiałów</h3>
                        <p class="text-gray-300 leading-relaxed">
                            Każdy slajd z prezentacji jest przetwarzany przez model językowy Gemini, który zamienia tekst na reprezentację matematyczną - wektor składający się z 768 liczb. Ten proces nazywany embeddingiem pozwala zapisać znaczenie treści w formie, którą komputer może porównywać. Wszystkie wektory trafiają do specjalistycznej bazy danych Qdrant, zaprojektowanej do przechowywania i szybkiego przeszukiwania takich reprezentacji. Razem z wektorami zapisywane są metadane: nazwa prezentacji, numer slajdu i oryginalna treść.
                        </p>
                    </div>

                    <div class="bg-white/5 border border-gray-600 rounded-xl p-6 space-y-4">
                        <h3 class="text-2xl font-bold text-purple-400">2. Przetwarzanie pytania</h3>
                        <p class="text-gray-300 leading-relaxed">
                            Gdy użytkownik zadaje pytanie, system wykonuje identyczny proces embeddingu - zamienia pytanie na wektor o tej samej strukturze co fragmenty w bazie. Ta wspólna reprezentacja matematyczna umożliwia porównywanie znaczenia pytania ze znaczeniem zapisanych materiałów, niezależnie od użytych słów czy sformułowań.
                        </p>
                    </div>

                    <div class="bg-white/5 border border-gray-600 rounded-xl p-6 space-y-4">
                        <h3 class="text-2xl font-bold text-green-400">3. Wyszukiwanie semantyczne</h3>
                        <p class="text-gray-300 leading-relaxed">
                            Baza Qdrant porównuje wektor pytania z wektorami wszystkich slajdów, obliczając podobieństwo cosinusowe - miarę matematyczną pokazującą jak bardzo dwa wektory "wskazują w tym samym kierunku". System zwraca 5-7 fragmentów o najwyższym podobieństwie, pomijając slajdy zawierające głównie pytania aktywizujące. Każdy wynik otrzymuje score od 0 do 1, gdzie wartości powyżej 0.7 wskazują na wysoką zgodność tematyczną. To podejście wykracza poza proste dopasowanie słów kluczowych - system rozpoznaje synonimy, powiązane koncepcje i kontekst.
                        </p>
                    </div>

                    <div class="bg-white/5 border border-gray-600 rounded-xl p-6 space-y-4">
                        <h3 class="text-2xl font-bold text-orange-400">4. Generowanie odpowiedzi</h3>
                        <p class="text-gray-300 leading-relaxed">
                            Znalezione fragmenty są przekazywane do modelu Gemini wraz z instrukcją o stworzeniu syntezy informacji. Model analizuje wszystkie fragmenty jednocześnie, identyfikuje kluczowe fakty, łączy powiązane informacje i formułuje spójną odpowiedź. Proces ten pozwala na przedstawienie wiedzy z kilku slajdów w formie ciągłej narracji, zachowując terminologię i poziom szczegółowości materiałów źródłowych. System automatycznie dołącza referencje do źródłowych slajdów.
                        </p>
                    </div>

                    <div class="bg-purple-600/20 border border-purple-400 rounded-xl p-6 space-y-3">
                        <h3 class="text-xl font-bold">Możliwości systemu</h3>
                        <p class="text-gray-300 leading-relaxed">
                            Architektura RAG (Retrieval-Augmented Generation) umożliwia zadawanie pytań w dowolnej formie - system rozpoznaje intencję niezależnie od sformułowania. Można pytać o definicje, procesy biochemiczne, związki między konceptami czy zastosowania kliniczne. Odpowiedzi są generowane wyłącznie na podstawie dostępnych materiałów, co eliminuje problem halucynacji typowy dla modeli językowych działających bez dostępu do konkretnych źródeł. System działa jako warstwa interpretacyjna między użytkownikiem a materiałami, umożliwiając eksplorację treści bez konieczności przeglądania dziesiątek slajdów czy znania dokładnej terminologii.
                        </p>
                    </div>
                    
                    <div class="bg-blue-600/20 border border-blue-400 rounded-xl p-4 text-center">
                        <p class="text-lg"><strong>Baza:</strong> 720 wektorów z 6 prezentacji biochemicznych</p>
                        <p class="text-sm text-gray-400 mt-1">Kolekcja: prezentacje_biochemia</p>
                    </div>
                </div>
            </div>`,

            // Slide 2: Live Demo
            `<div class="min-h-screen flex items-center justify-center p-8">
                <div class="max-w-6xl w-full">
                    <h2 class="text-4xl font-bold mb-8 text-center">Live Demo - Przetestuj sam!</h2>
                    
                    <!-- Sugestie zapytań -->
                    <div class="mb-6">
                        <p class="text-sm text-gray-400 mb-3">Przykładowe pytania (kliknij aby użyć):</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="askQuestion('Jak działa β-oksydacja?')" 
                                class="px-4 py-2 bg-blue-600/30 hover:bg-blue-600/50 border border-blue-400 rounded-lg text-sm transition">
                                Jak działa β-oksydacja?
                            </button>
                            <button onclick="askQuestion('Co to są lipoproteiny?')" 
                                class="px-4 py-2 bg-blue-600/30 hover:bg-blue-600/50 border border-blue-400 rounded-lg text-sm transition">
                                Co to są lipoproteiny?
                            </button>
                            <button onclick="askQuestion('Jakie enzymy są używane w diagnostyce?')" 
                                class="px-4 py-2 bg-blue-600/30 hover:bg-blue-600/50 border border-blue-400 rounded-lg text-sm transition">
                                Enzymy w diagnostyce
                            </button>
                            <button onclick="askQuestion('Opisz kinetykę reakcji enzymatycznej')" 
                                class="px-4 py-2 bg-blue-600/30 hover:bg-blue-600/50 border border-blue-400 rounded-lg text-sm transition">
                                Kinetyka enzymatyczna
                            </button>
                        </div>
                    </div>

                    <!-- Chat Interface -->
                    <div class="bg-white/5 backdrop-blur-sm rounded-2xl border border-gray-700 overflow-hidden">
                        <!-- Chat messages -->
                        <div id="chatMessages" class="h-96 overflow-y-auto p-6 space-y-4">
                            <div class="text-center text-gray-400 text-sm">
                                Zadaj pytanie o materiały szkoleniowe...
                            </div>
                        </div>
                        
                        <!-- Input -->
                        <div class="border-t border-gray-700 p-4 bg-black/20">
                            <div class="flex gap-3">
                                <input type="text" id="userInput" placeholder="Zadaj pytanie..." 
                                    class="flex-1 px-4 py-3 bg-white/5 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500"
                                    onkeypress="if(event.key==='Enter') searchKnowledgeBase()">
                                <button onclick="searchKnowledgeBase()" 
                                    class="px-8 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold transition">
                                    Szukaj
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center text-xs text-gray-500">
                        Backend: <span id="backendStatus" class="text-yellow-400">sprawdzanie...</span>
                    </div>
                </div>
            </div>`
        ];

        let currentSlideIndex = 0;

        function showSlide(index) {
            currentSlideIndex = index;
            document.getElementById('slides-container').innerHTML = slides[index];
            
            // Sprawdź status backendu jeśli jesteśmy na demo
            if (index === 1) {
                checkBackendStatus();
            }
        }

        async function checkBackendStatus() {
            try {
                const response = await fetch(`${BACKEND_URL}/health`);
                if (response.ok) {
                    document.getElementById('backendStatus').innerHTML = 
                        '<span class="text-green-400">✓ Połączony</span>';
                } else {
                    throw new Error('Niedostępny');
                }
            } catch (error) {
                document.getElementById('backendStatus').innerHTML = 
                    '<span class="text-red-400">✗ Niedostępny - backend uśpiony (pierwsze zapytanie go obudzi)</span>';
            }
        }

        function askQuestion(question) {
            document.getElementById('userInput').value = question;
            searchKnowledgeBase();
        }

        async function searchKnowledgeBase() {
            const query = document.getElementById('userInput').value.trim();
            if (!query) return;

            // Add user message
            addMessage('user', query);
            
            // Clear input
            document.getElementById('userInput').value = '';
            
            // Show loading
            const loadingId = addMessage('assistant', '🔍 Przeszukuję bazę wiedzy i generuję odpowiedź...');

            try {
                const response = await fetch(`${BACKEND_URL}/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });

                if (!response.ok) {
                    throw new Error('Błąd połączenia z backendem');
                }

                const data = await response.json();
                
                // Remove loading message
                document.getElementById(loadingId).remove();

                if (data.success) {
                    displayAnswer(data.answer, data.sources);
                } else {
                    addMessage('system', `❌ Błąd: ${data.error}`);
                }

            } catch (error) {
                document.getElementById(loadingId).remove();
                addMessage('system', `❌ Błąd: ${error.message}. Backend może być uśpiony - spróbuj ponownie za chwilę.`);
            }
        }

        function displayAnswer(answer, sources) {
            let answerHTML = `<div class="space-y-3">
                <div class="text-gray-100 leading-relaxed">${answer}</div>`;

            if (sources && sources.length > 0) {
                answerHTML += `<div class="pt-3 mt-3 border-t border-gray-600">
                    <div class="text-xs text-gray-400 mb-2">Źródła:</div>
                    <div class="space-y-1">`;
                
                sources.forEach((source, i) => {
                    const score = (source.score * 100).toFixed(0);
                    answerHTML += `
                        <div class="text-xs text-gray-400">
                            ${i + 1}. ${source.presentation} (Slajd ID: ${source.slide_id}) • ${score}% dopasowania
                        </div>
                    `;
                });
                
                answerHTML += `</div></div>`;
            }

            answerHTML += `</div>`;
            
            addMessage('assistant', answerHTML);
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = role === 'user' 
                ? 'flex justify-end' 
                : 'flex justify-start';
            
            const bubbleClass = role === 'user'
                ? 'bg-purple-600 text-white'
                : role === 'system'
                ? 'bg-yellow-600/30 border border-yellow-600 text-yellow-200'
                : 'bg-white/10 text-white';
            
            messageDiv.innerHTML = `
                <div class="max-w-3xl px-4 py-3 rounded-2xl ${bubbleClass}">
                    ${content}
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return messageId;
        }

        // Show first slide on load
        showSlide(0);
    </script>
</body>
</html>
